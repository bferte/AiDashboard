<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistant RAG - Analyseur de Performance</title>
    <style>
        :root {
            --primary: #007bff;
            --bg: #f4f7f6;
            --bot-msg: #ffffff;
            --user-msg: #007bff;
        }

        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: var(--bg); display: flex; flex-direction: column; height: 100vh; margin: 0; }
        
        /* Header avec s√©lection du mod√®le */
        #header { background: white; padding: 15px 25px; border-bottom: 1px solid #ddd; display: flex; align-items: center; gap: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .config-group { display: flex; align-items: center; gap: 10px; font-size: 14px; color: #444; }
        select { padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc; outline: none; cursor: pointer; }

        /* Conteneur de Chat */
        #chat-container { flex: 1; overflow-y: auto; padding: 25px; display: flex; flex-direction: column; gap: 20px; }
        .message { padding: 15px 20px; border-radius: 15px; max-width: 80%; line-height: 1.6; position: relative; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .user { background: var(--user-msg); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .bot { background: var(--bot-msg); color: #333; align-self: flex-start; border-bottom-left-radius: 2px; }

        /* Panneau de KPI (Statistiques) */
        .kpi-container { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 12px; padding-top: 10px; border-top: 1px solid #eee; }
        .kpi-card { background: #f8f9fa; padding: 5px 10px; border-radius: 6px; border: 1px solid #e9ecef; display: flex; align-items: center; gap: 6px; font-size: 11px; font-weight: 600; color: #555; }
        .kpi-icon { color: var(--primary); font-size: 14px; }

        .sources { font-size: 0.85em; color: #777; margin-top: 10px; font-style: italic; background: #fffdf0; padding: 5px; border-radius: 4px; }

        /* Animation de chargement */
        .typing { display: flex; gap: 5px; padding: 10px; }
        .dot { width: 8px; height: 8px; background: #ccc; border-radius: 50%; animation: blink 1.4s infinite both; }
        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink { 0%, 80%, 100% { opacity: 0.2; } 40% { opacity: 1; } }

        /* Zone de saisie */
        #input-area { background: white; padding: 20px 25px; display: flex; gap: 15px; border-top: 1px solid #ddd; }
        input { flex: 1; padding: 14px; border: 1px solid #ddd; border-radius: 10px; outline: none; font-size: 15px; }
        button { background: var(--primary); color: white; border: none; padding: 0 30px; border-radius: 10px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; }
    </style>
</head>
<body>

<div id="header">
    <div class="config-group">
        <strong>Mod√®le LLM :</strong>
        <select id="modelSelect">
            <option value="mistral:instruct">Mistral (Instruct)</option>
            <option value="llama3">Llama 3 (Meta)</option>
            <option value="gemma2">Gemma 2 (Google)</option>
            <option value="phi3">Phi-3 (Microsoft)</option>
        </select>
    </div>
</div>

<div id="chat-container">
    <div class="message bot">
        Bonjour ! Posez une question. Je vais interroger vos PDF et Eduscol, puis j'analyserai la performance de la r√©ponse.
    </div>
</div>

<div id="input-area">
    <input type="text" id="userInput" placeholder="√âcrivez votre message..." onkeypress="if(event.key === 'Enter') sendMessage()">
    <button onclick="sendMessage()" id="sendBtn">Envoyer</button>
</div>

<script>
    const container = document.getElementById('chat-container');

    async function sendMessage() {
        const input = document.getElementById('userInput');
        const btn = document.getElementById('sendBtn');
        const model = document.getElementById('modelSelect').value;
        const question = input.value.trim();

        if (!question) return;

        // Affichage message utilisateur
        appendMessage('user', question);
        input.value = '';
        input.disabled = true;
        btn.disabled = true;

        // Affichage Loader
        const loaderId = 'loader-' + Date.now();
        appendLoader(loaderId);

        const startTime = performance.now();

        try {
            const response = await fetch('http://localhost:8000/ask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question: question, model_name: model })
            });

            const data = await response.json();
            const duration = ((performance.now() - startTime) / 1000).toFixed(2);

            document.getElementById(loaderId).remove();
            
            // Construction du panneau KPI
            const kpiHtml = `
                <div class="kpi-container">
                    <div class="kpi-card" title="Temps total"><span class="kpi-icon">‚è±</span> ${duration}s</div>
                    <div class="kpi-card" title="Vitesse de g√©n√©ration"><span class="kpi-icon">‚ö°</span> ${data.tps} tk/s</div>
                    <div class="kpi-card" title="Pertinence du RAG"><span class="kpi-icon">üéØ</span> ${data.relevance}%</div>
                    <div class="kpi-card" title="Sources trouv√©es"><span class="kpi-icon">üìÑ</span> ${data.sources.length} docs</div>
                </div>
            `;

            let botContent = `<div>${data.answer}</div>${kpiHtml}`;
            
            if (data.sources && data.sources.length > 0) {
                botContent += `<div class="sources">Sources : ${data.sources.join(', ')}</div>`;
            }

            appendMessage('bot', botContent);

        } catch (error) {
            if(document.getElementById(loaderId)) document.getElementById(loaderId).remove();
            appendMessage('bot', "‚ùå Erreur de connexion avec l'API. V√©rifiez qu'Ollama et app.py sont lanc√©s.");
        } finally {
            input.disabled = false;
            btn.disabled = false;
            input.focus();
        }
    }

    function appendMessage(role, html) {
        const div = document.createElement('div');
        div.className = `message ${role}`;
        div.innerHTML = html;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    function appendLoader(id) {
        const div = document.createElement('div');
        div.id = id;
        div.className = 'message bot typing';
        div.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }
</script>

</body>
</html>